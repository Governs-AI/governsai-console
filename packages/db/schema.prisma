generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Org {
  id           String              @id @default(cuid())
  name         String              @unique
  slug         String              @unique
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  apiKeys      APIKey[]
  networkRules NetworkAccessRule[]
  memberships  OrgMembership[]
  channels     WebSocketChannel[]
  sessions     WebSocketSession[]
}

model User {
  id            String             @id @default(cuid())
  email         String             @unique
  emailVerified DateTime?
  name          String?
  image         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  apiKeys       APIKey[]
  auditLogs     AuditLog[]
  budgets       Budget[]
  credential    Credential?
  mfaTotp       MfaTotp?
  memberships   OrgMembership[]
  usageRecords  UsageRecord[]
  channels      WebSocketChannel[]
  sessions      WebSocketSession[]
}

model Credential {
  id            String    @id @default(cuid())
  userId        String    @unique
  passwordHash  String
  passwordSetAt DateTime  @default(now())
  resetToken    String?   @unique
  resetTokenExp DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OrgMembership {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  role      OrgRole  @default(VIEWER)
  createdAt DateTime @default(now())
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([userId])
  @@index([orgId, role])
}

model VerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  purpose   String  // "email-verify" | "invite"
  orgId     String?
  role      OrgRole?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email, purpose])
}

model MfaTotp {
  id           String   @id @default(cuid())
  userId       String   @unique
  secretBase32 String  // store encrypted-at-rest
  enabled      Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model APIKey {
  id           String             @id @default(cuid())
  key          String             @unique
  keyHash      String?            @unique
  name         String
  userId       String
  orgId        String             @map("org_id")
  scopes       String[]           @default([])
  env          String             @default("prod")
  isActive     Boolean            @default(true)
  lastUsed     DateTime?
  ipAllow      Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  expiresAt    DateTime?
  org          Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageRecords UsageRecord[]
  channels     WebSocketChannel[]

  @@index([key])
  @@index([keyHash])
  @@index([userId])
  @@index([orgId])
  @@index([isActive])
  @@index([lastUsed])
}

model NetworkAccessRule {
  id        String    @id @default(cuid())
  orgId     String    @map("org_id")
  kind      String
  value     String
  label     String?
  notes     String?
  isActive  Boolean   @default(true)
  expiresAt DateTime?
  createdBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  org       Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, kind, isActive])
  @@index([orgId, expiresAt])
  @@index([isActive])
}

model AIProvider {
  id           String        @id @default(cuid())
  name         String        @unique
  baseUrl      String
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  usageRecords UsageRecord[]
}

model UsageRecord {
  id               String     @id @default(cuid())
  userId           String
  orgId            String     @map("org_id")
  apiKeyId         String?
  providerId       String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  cost             Float
  createdAt        DateTime   @default(now())
  apiKey           APIKey?    @relation(fields: [apiKeyId], references: [id])
  provider         AIProvider @relation(fields: [providerId], references: [id])
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([orgId, createdAt])
  @@index([providerId, createdAt])
}

model Budget {
  id         String   @id @default(cuid())
  userId     String
  orgId      String   @map("org_id")
  name       String
  amount     Float
  usedAmount Float    @default(0)
  period     String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orgId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  orgId     String?  @map("org_id")
  action    String
  resource  String
  details   Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([orgId, createdAt])
  @@index([action, createdAt])
}

model Policy {
  id            String   @id @default(cuid())
  orgId         String   @map("org_id")
  userId        String?  @map("user_id")
  name          String
  description   String?
  version       String   @default("v1")
  defaults      Json
  toolAccess    Json     @default("{}") @map("tool_access")
  denyTools     Json     @default("[]") @map("deny_tools")
  allowTools    Json     @default("[]") @map("allow_tools")
  networkScopes Json     @default("[]") @map("network_scopes")
  networkTools  Json     @default("[]") @map("network_tools")
  onError       String   @default("block") @map("on_error")
  isActive      Boolean  @default(true)
  priority      Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orgId])
  @@index([userId])
  @@index([orgId, isActive])
  @@index([orgId, userId, isActive])
  @@index([priority])
}

model ToolConfig {
  id               String   @id @default(cuid())
  toolName         String   @unique @map("tool_name")
  displayName      String?  @map("display_name")
  description      String?
  category         String
  riskLevel        String   @map("risk_level")
  scope            String
  direction        String   @default("both")
  metadata         Json     @default("{}")
  requiresApproval Boolean  @default(false) @map("requires_approval")
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([category])
  @@index([riskLevel])
  @@index([scope])
  @@index([isActive])
}

model Decision {
  id              String   @id @default(cuid())
  orgId           String   @map("org_id")
  direction       String
  decision        String
  tool            String?
  scope           String?
  detectorSummary Json     @default("{}") @map("detector_summary")
  payloadHash     String   @map("payload_hash")
  payloadOut      Json?    @map("payload_out")
  reasons         Json?    @default("[]")
  policyId        String?  @map("policy_id")
  latencyMs       Int?     @map("latency_ms")
  correlationId   String?  @map("correlation_id")
  tags            Json     @default("[]")
  ts              DateTime @default(now())

  @@index([orgId, ts(sort: Desc)])
  @@index([decision])
  @@index([direction])
  @@index([tool])
  @@index([correlationId])
  @@index([policyId])
}

model WebSocketGateway {
  id          String             @id @default(cuid())
  name        String
  url         String
  isActive    Boolean            @default(true)
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  sessions    WebSocketSession[]

  @@index([isActive])
}

model WebSocketChannel {
  id          String   @id @default(cuid())
  orgId       String?  @map("org_id")
  userId      String?  @map("user_id")
  keyId       String?  @map("key_id")
  channelType String
  channelName String
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  key         APIKey?  @relation(fields: [keyId], references: [id], onDelete: Cascade)
  org         Org?     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([userId])
  @@index([keyId])
  @@index([channelType])
  @@index([channelType, channelName])
  @@index([orgId, isActive])
  @@index([userId, isActive])
  @@index([keyId, isActive])
}

model WebSocketSession {
  id        String           @id @default(cuid())
  userId    String
  orgId     String?          @map("org_id")
  sessionId String           @unique
  gatewayId String
  channels  Json
  cursor    Json?
  isActive  Boolean          @default(true)
  lastSeen  DateTime         @default(now())
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  gateway   WebSocketGateway @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  org       Org?             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orgId])
  @@index([sessionId])
  @@index([isActive])
  @@index([lastSeen])
}

enum OrgRole {
  OWNER
  ADMIN
  DEVELOPER
  VIEWER
}
